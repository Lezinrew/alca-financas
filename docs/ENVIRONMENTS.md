# Environment Configuration Guide

## Overview

This document explains the environment variables used in Alça Finanças and how to configure them for DEV and PROD environments.

## Environment Files

### Root Directory
- `.env.example` - Template with all available variables (safe to commit)
- `.env` - Your local development configuration (NEVER commit)
- `.env.production` - Production configuration (NEVER commit)

### Backend Directory (`backend/`)
- Backend reads from root `.env` file via `python-dotenv`
- All backend environment variables are loaded in `backend/app.py`

### Frontend Directory (`frontend/`)
- Frontend uses Vite environment variables (prefixed with `VITE_`)
- `.env` is auto-generated by `scripts/dev/up.sh`
- Vite only exposes `VITE_*` variables to the browser

### Mobile Directory (`mobile/`)
- Mobile reads from root `.env` via Expo
- Uses standard React Native environment variables

---

## Required Variables

### Supabase (CRITICAL)

```bash
# Get these from: https://app.supabase.com/project/_/settings/api
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJhbGc...     # Safe for frontend (optional for frontend-only apps)
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...  # BACKEND ONLY, has admin privileges
```

**Important: Standard Environment Variable Names**

This project uses the **official Supabase naming convention**:
- ✅ `SUPABASE_SERVICE_ROLE_KEY` - Standard name for backend
- ✅ `SUPABASE_ANON_KEY` - Standard name for frontend (if needed)
- ⚠️ `SUPABASE_KEY` - **Deprecated**, use `SUPABASE_SERVICE_ROLE_KEY`
- ⚠️ `SUPABASE_LEGACY_JWT` - **Deprecated**, use `SUPABASE_SERVICE_ROLE_KEY`

**Security Notes:**
- ✅ `SUPABASE_ANON_KEY` - Safe for frontend, respects Row Level Security (RLS)
- ⚠️ `SUPABASE_SERVICE_ROLE_KEY` - NEVER expose to frontend, bypasses RLS
- The backend uses `SUPABASE_SERVICE_ROLE_KEY` for admin operations
- The frontend should NEVER receive the service role key
- Backend will accept legacy names with deprecation warnings

### Backend Configuration

```bash
BACKEND_PORT=8001           # Port for Flask API (default: 8001)
HOST=0.0.0.0                # Bind address (0.0.0.0 allows network access)
SECRET_KEY=random-secret    # Flask session encryption key
JWT_SECRET=random-jwt       # JWT token signing key
JWT_EXPIRES_HOURS=24        # JWT token expiration (default: 24h)
```

### Frontend Configuration

```bash
FRONTEND_PORT=3000          # Vite dev server port (default: 3000)
VITE_API_URL=http://localhost:8001  # Backend API URL for frontend
```

### CORS Configuration

```bash
# Comma-separated origins allowed to call the API
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000
```

**DEV:** Include all localhost ports you use
**PROD:** Include only your production domain(s)

---

## Optional Variables

### OAuth Providers

```bash
# Google OAuth (https://console.cloud.google.com/)
GOOGLE_CLIENT_ID=...apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-...
GOOGLE_REDIRECT_URI=http://localhost:8001/api/auth/google/callback

# Microsoft OAuth (https://portal.azure.com/)
MICROSOFT_CLIENT_ID=...
MICROSOFT_CLIENT_SECRET=...

# Apple OAuth (https://developer.apple.com/)
APPLE_CLIENT_ID=...
APPLE_CLIENT_SECRET=...
```

### Email Service

```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password  # Use app-specific password, not account password
```

### Monitoring

```bash
# Sentry for error tracking
SENTRY_DSN=https://...@sentry.io/...

# Google Analytics
GOOGLE_ANALYTICS_ID=GA-XXXXXXXXX
```

---

## Environment-Specific Configuration

### Development Environment

**File:** `.env` (root directory)

```bash
NODE_ENV=development
FLASK_ENV=development

# Use localhost URLs
VITE_API_URL=http://localhost:8001
GOOGLE_REDIRECT_URI=http://localhost:8001/api/auth/google/callback

# CORS includes localhost variations
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:3001,http://127.0.0.1:3000

# Development secrets (change these!)
SECRET_KEY=dev-secret-key
JWT_SECRET=dev-jwt-secret
```

**Running DEV:**
```bash
# Setup once
./scripts/dev/setup.sh

# Start services
./scripts/dev/up.sh

# Check health
./scripts/dev/doctor.sh

# Stop services
./scripts/dev/down.sh
```

### Production Environment

**File:** `.env.production` (root directory, NEVER commit)

```bash
NODE_ENV=production
FLASK_ENV=production

# Use production URLs
VITE_API_URL=https://api.yourdomain.com
GOOGLE_REDIRECT_URI=https://api.yourdomain.com/api/auth/google/callback

# CORS restricted to production domain
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# Strong secrets (use random 32+ character strings)
SECRET_KEY=<generate-with-openssl-rand-hex-32>
JWT_SECRET=<generate-with-openssl-rand-hex-32>

# Production Supabase project
SUPABASE_URL=https://your-prod-project.supabase.co
SUPABASE_ANON_KEY=<prod-anon-key>
SUPABASE_SERVICE_ROLE_KEY=<prod-service-role-key>
```

**Generating Production Secrets:**
```bash
# Generate random secrets
openssl rand -hex 32

# Or use Python
python3 -c "import secrets; print(secrets.token_hex(32))"
```

**Running PROD:**
```bash
# Build once
./scripts/prod/build.sh

# Run production server
./scripts/prod/run.sh
```

---

## Variable Usage by Component

### Backend (`backend/app.py`)
- Reads: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` (NOT anon key)
- Reads: `SECRET_KEY`, `JWT_SECRET`, `CORS_ORIGINS`
- Reads: OAuth credentials if configured
- Port: `BACKEND_PORT` (default: 8001)

### Frontend (`frontend/src/`)
- Reads: `VITE_API_URL` (set by dev scripts)
- Should NEVER have access to `SUPABASE_SERVICE_ROLE_KEY`
- Should NEVER have access to `SECRET_KEY` or `JWT_SECRET`
- Port: `FRONTEND_PORT` (default: 3000)

### Mobile (`mobile/`)
- Reads: Similar to frontend, only safe public variables
- Uses `SUPABASE_ANON_KEY` if directly accessing Supabase

---

## Security Best Practices

### ✅ DO:
- Use `.env.example` as a template
- Generate strong random secrets for production
- Use environment-specific Supabase projects (dev/prod)
- Restrict CORS to specific domains in production
- Use HTTPS in production
- Use Supabase RLS (Row Level Security) policies
- Rotate secrets periodically

### ❌ DON'T:
- NEVER commit `.env` or `.env.production` files
- NEVER expose `SUPABASE_SERVICE_ROLE_KEY` to frontend
- NEVER use development secrets in production
- NEVER share `.env` files via insecure channels
- NEVER use `CORS_ORIGINS=*` in production
- NEVER store secrets in source code

---

## Troubleshooting

### Backend can't connect to Supabase
```bash
# Verify variables are loaded
./scripts/dev/doctor.sh

# Check backend logs
tail -f logs/backend-*.log

# Test Supabase connection manually
curl -H "apikey: YOUR_ANON_KEY" \
     -H "Authorization: Bearer YOUR_ANON_KEY" \
     https://your-project.supabase.co/rest/v1/
```

### Frontend can't reach backend
```bash
# Check if backend is running
curl http://localhost:8001/api/health

# Verify VITE_API_URL in frontend/.env
cat frontend/.env

# Check CORS configuration
# Backend logs should show allowed origins
```

### CORS errors
```bash
# Add your origin to CORS_ORIGINS
CORS_ORIGINS=http://localhost:3000,http://localhost:5173

# Restart backend after changing CORS
./scripts/dev/down.sh && ./scripts/dev/up.sh
```

---

## Migration from MongoDB

If you're migrating from MongoDB:
1. Remove all `MONGO_URI` and `MONGO_DB` variables
2. Add Supabase variables as shown above
3. The backend now uses `repositories/*_repository_supabase.py` instead of MongoDB
4. Data migration: use `scripts/db/migrate.sh` (see PROD scripts)

---

## References

- [Supabase Environment Variables](https://supabase.com/docs/guides/getting-started/environment-variables)
- [Vite Environment Variables](https://vitejs.dev/guide/env-and-mode.html)
- [Flask Configuration](https://flask.palletsprojects.com/en/latest/config/)
- [Expo Environment Variables](https://docs.expo.dev/guides/environment-variables/)
